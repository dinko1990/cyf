<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Check Your Flat ‚Äì v10</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4ff;
      color: #1b1330;
    }

    /* ====== LAYOUT SHELL (SIDEBAR + MAIN) ====== */
    .app {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    /* SIDEBAR (desktop) */
    .sidebar {
      width: 260px;
      background: #1c0f33;
      color: #f7f6ff;
      display: flex;
      flex-direction: column;
      padding: 20px 18px;
      position: relative;
      transition: width 0.2s ease;
    }
    .sidebar.collapsed {
      width: 72px;
      padding: 20px 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .brand-logo {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffb85c, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 28px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.15);
      flex-shrink: 0;
    }
    .brand-text h1 {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.2;
    }
    .brand-text span {
      font-size: 11px;
      opacity: 0.7;
    }
    .sidebar.collapsed .brand-text { display: none; }

    .sidebar-toggle {
      position: absolute;
      top: 16px;
      right: -12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #241238;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      z-index: 10;
    }

    .sidebar nav {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }
    .nav-item {
      background: transparent;
      border: none;
      color: #e9e8ff;
      padding: 10px 12px;
      border-radius: 12px;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s, transform 0.1s;
    }
    .nav-item span.icon {
      font-size: 18px;
      opacity: 0.9;
      flex-shrink: 0;
    }
    .sidebar.collapsed .nav-item span:not(.icon) { display: none; }
    .nav-item.active {
      background: linear-gradient(135deg, #ffb85c, #ff6b9c);
      color: #1b1330;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }
    .nav-item.active:hover {
      background: linear-gradient(135deg, #ffc977, #ff88ae);
    }
    .nav-logout {
      margin-top: auto;
      background: rgba(255,255,255,0.04);
      font-size: 13px;
    }

    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .hero {
      position: relative;
      padding: 28px 40px 60px;
      background: #fefbff;
      overflow: hidden;
    }
    .hero-title {
      font-size: clamp(32px, 4vw, 44px);
      font-weight: 700;
      color: #1c1033;
      letter-spacing: 0.02em;
    }
    .hero-subtitle {
      margin-top: 8px;
      font-size: 14px;
      color: #5f547b;
      max-width: 480px;
    }
    .hero-wave {
      position: absolute;
      left: 0;
      bottom: -100px;
      width: 150%;
      height: 160px;
      background: #241238;
      border-radius: 50% 50% 0 0;
    }
    .hero-badge {
      position: absolute;
      right: 40px;
      top: 26px;
      background: #241238;
      color: #fefbff;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.16);
    }
    .hero-badge .icon { font-size: 16px; }

    .content {
      flex: 1;
      padding: 0 32px 32px;
      position: relative;
      margin-top: -80px;
    }
    .content > .card-shell {
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(11, 0, 40, 0.2);
      padding: 20px 18px;
      background: #f4f4ff;
    }

    /* BASIC CARD (INSIDE SHELL) */
    .card {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      padding: 14px;
      margin-bottom: 14px;
      position: relative;
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .step-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 600;
    }
    .step-chip {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      background: #241238;
      color: #fff;
    }
    .step-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f0ecff;
      color: #5c4f94;
    }
    .step-help {
      font-size: 11px;
      color: #7a719d;
      text-align: right;
    }
    .step-disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    /* HORIZONTAL STEP BAR */
    .steps-floating {
      position: sticky;
      top: 0;
      margin: 0 auto 10px auto;
      z-index: 90;
      display: flex;
      justify-content: center;
    }
    .steps-inner {
      background: #241238;
      border-radius: 999px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      padding: 4px 6px;
      display: flex;
      gap: 4px;
    }
    .steps-inner button {
      min-width: 32px;
      height: 28px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #fefbff;
      opacity: 0.4;
      padding: 0 10px;
    }
    .steps-inner button.unlocked {
      opacity: 0.9;
    }
    .steps-inner button.active {
      background: #ff8fa3;
      color: #241238;
      opacity: 1;
    }
    .steps-inner button:disabled {
      cursor: default;
      opacity: 0.2;
    }

    /* MOBILE LEFT FLOATING MENU */
    .mobile-left-menu {
      position: fixed;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 120;
      display: none;
      font-size: 12px;
    }
    .mobile-left-toggle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #241238;
      color: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.4);
      cursor: pointer;
      font-size: 16px;
    }
    .mobile-left-items {
      margin-top: 6px;
      background: #241238;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.45);
      padding: 6px 4px;
      display: none;
      flex-direction: column;
      gap: 4px;
    }
    .mobile-left-menu.open .mobile-left-items {
      display: flex;
    }
    .mobile-left-items button {
      border: none;
      background: transparent;
      color: #fefbff;
      padding: 4px 10px;
      text-align: left;
      cursor: pointer;
      font-size: 11px;
      border-radius: 8px;
    }
    .mobile-left-items button:hover {
      background: rgba(255,255,255,0.12);
    }

    /* STEP 1: UPLOAD */
    .drop-area {
      border-radius: 12px;
      border: 1.5px dashed #bfb5ff;
      text-align: center;
      padding: 14px;
      background: #faf9ff;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, transform 0.1s;
    }
    .drop-area.dragover {
      border-color: #ff7d9b;
      background: #ffeef5;
      transform: translateY(-1px);
    }
    .drop-area h3 {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .drop-area p {
      font-size: 11px;
      color: #7d739d;
    }
    .upload-btn-main {
      margin-top: 8px;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb85c, #ff6b9c);
      color: #1b1330;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(255,99,147,0.4);
    }
    .file-info {
      margin-top: 6px;
      font-size: 11px;
      color: #5f557e;
    }
    .example-chip {
      margin-top: 8px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #bfe4ff;
      background: linear-gradient(135deg, #e7f5ff, #e9fff4);
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: #19445e;
      font-weight: 500;
    }

    /* TABLE STEP */
    .table-wrapper {
      border-radius: 12px;
      border: 1px solid #e2dbff;
      background: #fff;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 680px;
    }
    thead {
      background: #241238;
      color: #f6efff;
    }
    th, td {
      padding: 7px 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-size: 10px;
    }
    tbody tr:nth-child(odd) {
      background: #faf8ff;
    }
    tbody td:first-child {
      font-weight: 600;
    }

    .expose-cell {
      color: #635a86;
    }
    td.editable {
      background: #e9fff4;
      border-left: 2px solid #4ecb9f;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .cell-editable {
      display: inline-block;
      min-height: 18px;
      width: 100%;
      outline: none;
    }
    .copy-btn {
      border-radius: 999px;
      border: 1px solid #89d7b1;
      padding: 3px 8px;
      font-size: 9px;
      background: #ffffff;
      color: #147457;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      white-space: nowrap;
      align-self: flex-start;
    }
    .copy-btn:hover {
      background: #e3f8f0;
    }

    .row-type-tag {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      background: #efe5ff;
      font-size: 9px;
      color: #5a4b8a;
      margin-left: 6px;
    }

    .trash-inline {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      color: #d62839;
      margin-left: 6px;
    }

    tr.mandatory-row td:first-child::after {
      content: " *";
      color: #d62839;
      font-weight: 700;
    }

    .table-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      padding: 8px 10px;
      border-top: 1px solid #eee7ff;
      background: #f7f4ff;
    }

    .btn-chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid #d7cef8;
      background: #ffffff;
      color: #43356e;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-chip.primary {
      border-color: #ff9bb7;
      background: #ffe7f1;
      color: #9a1f4e;
      font-weight: 600;
    }
    .btn-chip.mock {
      border-style: dashed;
      opacity: 0.9;
    }

    /* PHOTO CELL */
    .photo-upload-btn {
      border-radius: 999px;
      border: 1px dashed #d0c4ff;
      background: #f9f7ff;
      padding: 4px 10px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    .photo-editor {
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #ebe2ff;
      padding: 5px;
      background: #fdfbff;
      max-width: 280px;
    }
    .photo-helper {
      font-size: 9px;
      color: #7a6f9f;
      margin-bottom: 3px;
    }
    .photo-editor canvas {
      width: 100%;
      max-width: 260px;
      border-radius: 6px;
      background: #111;
      display: none;
      touch-action: none;
    }
    .photo-comments {
      margin-top: 2px;
      padding-left: 15px;
      font-size: 9px;
      color: #4a3c78;
      max-height: 70px;
      overflow-y: auto;
    }
    .photo-comments li { margin-bottom: 2px; }
    .photo-note {
      width: 100%;
      font-size: 10px;
      border-radius: 8px;
      border: 1px solid #dcd3ff;
      padding: 4px 6px;
      margin-top: 4px;
      resize: vertical;
    }

    /* VALIDATOR & SIGNATURE STEP */
    .field-row {
      display: grid;
      grid-template-columns: 1.1fr 2fr;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .field-row label {
      font-size: 11px;
      color: #6c618b;
    }
    .field-row input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #dcd3ff;
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .field-row input:focus {
      border-color: #ff8fa3;
      box-shadow: 0 0 0 2px rgba(255,143,163,0.25);
    }

    .sig-container {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #e2dbff;
      padding: 6px;
      background: #faf8ff;
    }
    .sig-label {
      font-size: 11px;
      margin-bottom: 4px;
      color: #5b4f8c;
    }
    #signature-pad {
      width: 100%;
      height: 120px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #dcd3ff;
      touch-action: none;
    }
    .sig-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 10px;
    }

    .btn-primary {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb85c, #ff6b9c);
      color: #1b1330;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(255,99,147,0.5);
    }
    .btn-outline {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 11px;
      border: 1px solid #d7cef8;
      background: #ffffff;
      color: #4d3f7a;
      cursor: pointer;
    }

    .field-error {
      border-color: #d62839 !important;
      box-shadow: 0 0 0 2px rgba(214,40,57,0.23) !important;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .row-error td.editable {
      background: #ffe5e8;
      border-left-color: #d62839;
      transition: background 0.2s ease, border-left-color 0.2s ease;
    }

    /* PDF MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(12,0,40,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-backdrop.visible { display: flex; }
    .modal {
      width: min(900px, 94vw);
      height: min(620px, 88vh);
      background: #fdfbff;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      padding: 8px 12px;
      background: #241238;
      color: #fefbff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .modal-header h2 {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-body {
      flex: 1;
      background: #161224;
    }
    .modal-body iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #161224;
    }
    .modal-footer {
      padding: 6px 10px;
      background: #f7f2ff;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      font-size: 10px;
      flex-wrap: wrap;
    }
    .close-x {
      background: transparent;
      border: none;
      color: #fefbff;
      font-size: 18px;
      cursor: pointer;
    }

    /* CAMERA MODAL */
    #camera-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #camera-modal.visible { display: flex; }
    .camera-inner {
      width: min(480px, 100vw);
      background: #000;
      border-radius: 10px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #fff;
    }
    #camera--view {
      width: 100%;
      border-radius: 8px;
      background: #000;
    }
    #camera--trigger {
      border-radius: 999px;
      padding: 8px;
      border: none;
      background: #ffffff;
      color: #111;
      font-size: 13px;
      margin-top: 2px;
      cursor: pointer;
    }
    #camera-close {
      border-radius: 999px;
      padding: 4px 10px;
      background: transparent;
      border: 1px solid #fff;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      align-self: flex-start;
    }

    /* HISTORY */
    .history-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .history-item {
      border-radius: 10px;
      border: 1px solid #ebe4ff;
      padding: 7px 9px;
      margin-bottom: 6px;
      font-size: 11px;
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .history-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .history-meta {
      color: #7a719d;
      font-size: 10px;
    }
    .history-tag {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #efe7ff;
      color: #5c4c8c;
    }

    /* MOBILE TABLE CARDS */
    @media (max-width: 768px) {
      .table-wrapper {
        overflow-x: visible;
      }
      table {
        border: 0;
        min-width: 0;
      }
      thead { display: none; }
      tbody, tr, td {
        display: block;
        width: 100%;
      }
      tbody tr {
        margin-bottom: 10px;
        border-radius: 10px;
        border: 1px solid #e2dbff;
        background: #ffffff;
        overflow: hidden;
      }
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #eee7ff;
        position: relative;
      }
      td::before {
        content: attr(data-label);
        display: block;
        font-size: 9px;
        color: #8a7fb0;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 2px;
      }
      td:last-child {
        border-bottom: none;
      }

      .mobile-left-menu {
        display: block;
      }
    }

    /* MOBILE ‚Äì hide sidebar and adjust hero/card */
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .hero {
        padding: 20px 20px 60px;
      }
      .hero-badge { display: none; }
      .content {
        padding: 0 10px 24px;
        margin-top: 0;
      }
      .content > .card-shell {
        margin-top: 0;
        box-shadow: none;
        border-radius: 0;
        padding: 10px 0 24px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo">ü¶â</div>
      <div class="brand-text">
        <h1>Check Your Flat</h1>
        <span>Inspector view ‚Äì Berlin</span>
      </div>
    </div>
    <button id="sidebar-toggle" class="sidebar-toggle" title="Collapse / expand sidebar">¬´</button>

    <nav>
      <button class="nav-item active" data-view="new">
        <span class="icon">‚ûï</span>
        <span>New Inspection</span>
      </button>
      <button class="nav-item" data-view="history">
        <span class="icon">üìÇ</span>
        <span>History</span>
      </button>
      <button class="nav-item nav-logout" data-view="logout">
        <span class="icon">üö™</span>
        <span>Logout</span>
      </button>
    </nav>
  </aside>

  <!-- MAIN AREA -->
  <main class="main">
    <header class="hero">
      <div class="hero-badge">
        <span class="icon">‚úÖ</span>
        <span>Compare reality vs expos√©, with photos & signature.</span>
      </div>
      <h1 class="hero-title">check your flat</h1>
      <p class="hero-subtitle">
        Upload the expos√©, walk through the flat, compare reality vs listing,
        add photos with markers, sign and export a PDF report ‚Äì all from your phone.
      </p>
      <div class="hero-wave"></div>
    </header>

    <section class="content">
      <div class="card-shell">
        <!-- HORIZONTAL STEP BAR -->
        <div class="steps-floating" id="steps-floating">
          <div class="steps-inner">
            <button data-step="1" class="active unlocked">1</button>
            <button data-step="2" disabled>2</button>
            <button data-step="3" disabled>3</button>
          </div>
        </div>

        <!-- MOBILE LEFT FLOATING MENU -->
        <div class="mobile-left-menu" id="mobile-left-menu">
          <button id="mobile-left-toggle" class="mobile-left-toggle">‚ò∞</button>
          <div class="mobile-left-items">
            <button id="nav-new-expose">New expos√©</button>
            <button id="nav-history">History</button>
            <button id="nav-logout-mobile">Logout</button>
          </div>
        </div>

        <!-- STEP 1 -->
        <section class="card" id="step1-card">
          <div class="step-header">
            <div class="step-title">
              <span class="step-chip">1</span>
              <span>Upload expos√© (PDF)</span>
              <span class="step-badge">Start here</span>
            </div>
            <div class="step-help">
              After loading, step 2 unlocks.
            </div>
          </div>

          <div id="drop-area" class="drop-area">
            <h3>Drop the expos√© PDF here</h3>
            <p>or tap the button to pick it from your phone.</p>
            <button type="button" id="select-file-btn" class="upload-btn-main">
              Browse file
            </button>
            <input type="file" id="file-input" accept="application/pdf" style="display:none" />
            <div id="file-info" class="file-info">No file loaded yet.</div>

            <div id="load-example-btn" class="example-chip">
              <span>üèôÔ∏è Use fake Berlin example (Kantstra√üe 123)</span>
            </div>
          </div>
        </section>

        <!-- STEP 2 -->
        <section class="card step-disabled" id="step2-card">
          <div class="step-header">
            <div class="step-title">
              <span class="step-chip">2</span>
              <span>Maske Inspektion ‚Äì Reality vs Expos√©</span>
              <span class="step-badge">Mandatory fields marked *</span>
            </div>
            <div class="step-help">
              Fill reality; "Copy from expos√©" just helps you start.
            </div>
          </div>

          <div class="table-wrapper">
            <table id="comparison-table">
              <thead>
                <tr>
                  <th>Field</th>
                  <th>üè¢ Expos√©</th>
                  <th>‚úÖ Reality</th>
                </tr>
              </thead>
              <tbody id="comparison-body">
                <!-- rows injected by JS -->
              </tbody>
            </table>
            <div class="table-actions">
              <div>
                <button type="button" id="add-text-row-btn" class="btn-chip">
                  Ôºã Add custom text row
                </button>
                <button type="button" id="add-photo-row-btn" class="btn-chip">
                  üì∑ Add photo row
                </button>
              </div>
              <div>
                <button type="button" id="reset-example-btn" class="btn-chip primary">
                  Reset to Maske Inspektion (Berlin example)
                </button>
                <button type="button" id="mock-autofill-btn" class="btn-chip mock">
                  üß™ Auto-fill sample notes (mock)
                </button>
              </div>
            </div>
          </div>

          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button type="button" id="go-step3-btn" class="btn-primary">
              Continue to Step 3 (summary &amp; PDF)
            </button>
          </div>
        </section>

        <!-- STEP 3 -->
        <section class="card step-disabled" id="step3-card">
          <div class="step-header">
            <div class="step-title">
              <span class="step-chip">3</span>
              <span>Validator, signature & PDF</span>
              <span class="step-badge">Final step</span>
            </div>
            <div class="step-help">
              Name & signature appear at the bottom of the report.
            </div>
          </div>

          <div class="field-row">
            <label for="validator">
              Validator / inspector name <span style="color:#d62839">*</span>
            </label>
            <input id="validator" placeholder="e.g. Max Mustermann" />
          </div>

          <p style="font-size:11px;color:#7a719d;margin-bottom:4px;">
            Logo: if <strong>Logo.png</strong> exists in the same folder, it will be used in the header (fallback CYF circle otherwise).
          </p>

          <div class="sig-container">
            <div class="sig-label">
              Signature (sign with your finger on mobile ‚Äì will be saved in the PDF)
            </div>
            <canvas id="signature-pad"></canvas>
            <div class="sig-actions">
              <button type="button" id="clear-signature-btn" class="btn-outline">
                Clear signature
              </button>
              <span>Sign now, then tap ‚ÄúGenerate &amp; Preview PDF‚Äù.</span>
            </div>
          </div>

          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button type="button" id="generate-pdf-btn" class="btn-primary">
              Generate &amp; Preview PDF
            </button>
          </div>
        </section>

        <!-- HISTORY -->
        <section class="card" id="history-card">
          <div class="history-title">History (local to this browser)</div>
          <div id="history-list"></div>
        </section>
      </div>
    </section>
  </main>
</div>

<!-- PDF PREVIEW MODAL -->
<div id="pdf-modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h2><span>ü¶â</span> Preview inspection report</h2>
      <div id="modal-validator-label"></div>
      <button type="button" id="close-modal-btn" class="close-x">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="pdf-preview-frame" title="PDF preview"></iframe>
    </div>
    <div class="modal-footer">
      <span id="modal-validator-footer"></span>
      <div>
        <button type="button" id="cancel-download-btn" class="btn-outline">
          Cancel
        </button>
        <button type="button" id="approve-download-btn" class="btn-primary">
          Approve &amp; Download
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CAMERA MODAL -->
<div id="camera-modal">
  <div class="camera-inner">
    <button id="camera-close">‚úï Close</button>
    <video id="camera--view" autoplay playsinline></video>
    <button id="camera--trigger">Take a picture</button>
    <canvas id="camera--sensor" style="display:none;"></canvas>
    <img src="//:0" alt="" id="camera--output" style="display:none;"/>
  </div>
</div>

<script>
(function() {
  const { jsPDF } = window.jspdf;

  /* ===== SIDEBAR NAV ===== */
  const navItems = document.querySelectorAll(".nav-item");
  const sidebarEl = document.getElementById("sidebar");
  const sidebarToggle = document.getElementById("sidebar-toggle");
  const step1Card = document.getElementById("step1-card");
  const historyCard = document.getElementById("history-card");

  navItems.forEach(btn => {
    btn.addEventListener("click", () => {
      navItems.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const view = btn.getAttribute("data-view");
      if (view === "new") {
        step1Card.scrollIntoView({ behavior: "smooth", block: "start" });
      } else if (view === "history") {
        historyCard.scrollIntoView({ behavior: "smooth", block: "start" });
      } else if (view === "logout") {
        alert("Logout is not wired yet ‚Äì plug this into your auth flow.");
      }
    });
  });

  sidebarToggle.addEventListener("click", () => {
    sidebarEl.classList.toggle("collapsed");
    sidebarToggle.textContent = sidebarEl.classList.contains("collapsed") ? "¬ª" : "¬´";
  });

  /* ===== STEP GATING (1‚Äì2‚Äì3) ===== */
  let currentMaxStep = 1;
  const stepsFloating = document.getElementById("steps-floating");
  const stepButtons = stepsFloating.querySelectorAll("button");
  const stepCards = {
    1: document.getElementById("step1-card"),
    2: document.getElementById("step2-card"),
    3: document.getElementById("step3-card")
  };

  function updateStepAccess() {
    stepButtons.forEach(btn => {
      const s = parseInt(btn.dataset.step, 10);
      btn.disabled = s > currentMaxStep;
      btn.classList.toggle("unlocked", s <= currentMaxStep);
      btn.classList.toggle("active", false);
    });
    stepButtons.forEach(btn => {
      const s = parseInt(btn.dataset.step, 10);
      if (s === currentMaxStep) btn.classList.add("active");
    });
    Object.entries(stepCards).forEach(([n, card]) => {
      const num = parseInt(n, 10);
      if (num <= currentMaxStep) {
        card.classList.remove("step-disabled");
      } else {
        card.classList.add("step-disabled");
      }
    });
  }

  stepButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const s = parseInt(btn.dataset.step, 10);
      if (s > currentMaxStep) return;
      const card = stepCards[s];
      if (card) {
        card.scrollIntoView({ behavior: "smooth", block: "start" });
        stepButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      }
    });
  });

  updateStepAccess();

  /* ===== MOBILE LEFT MENU ===== */
  const mobileMenu = document.getElementById("mobile-left-menu");
  const mobileToggle = document.getElementById("mobile-left-toggle");
  const navNew = document.getElementById("nav-new-expose");
  const navHistory = document.getElementById("nav-history");
  const navLogoutMobile = document.getElementById("nav-logout-mobile");

  mobileToggle.addEventListener("click", () => {
    mobileMenu.classList.toggle("open");
  });

  navNew.addEventListener("click", () => {
    mobileMenu.classList.remove("open");
    if (confirm("Start a new expos√©? This will reset the mask to defaults.")) {
      window.location.reload();
    }
  });

  navHistory.addEventListener("click", () => {
    mobileMenu.classList.remove("open");
    historyCard.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  navLogoutMobile.addEventListener("click", () => {
    mobileMenu.classList.remove("open");
    alert("Logout is not wired yet ‚Äì plug this into your auth flow.");
  });

  /* ===== SAMPLE EXPOSE DATA ===== */
  const EXPOSE_DATA = {
    adresse: "Kantstra√üe 123, 10625 Berlin",
    objekttyp: "Etagenwohnung",
    baujahr: "1960",
    wohnflaeche: "ca. 67 m¬≤",
    grundstueck: "",
    etage: "2",
    vollgeschosse: "5",
    keller: "Kellerabteil vorhanden",
    fassade_daemmung: "",
    dachgeschoss: "",
    straenge: "",
    fenster_material: "",
    fenster_verglas: "",
    baujahr_fenster: "",
    heizung: "Fernw√§rme (Gas)",
    baujahr_heizung: "",
    warmwasser: "zentral (mit Warmwasser)"
  };

  /* ===== CONFIGURABLE MANDATORY FIELDS ===== */
  const MANDATORY_FIELDS = ["keller" ,"adresse", "wohnflaeche"]; 
  // Add/remove field ids here: e.g. ["keller", "adresse", "wohnflaeche"]

  const inspectionFields = [
    { id: "adresse",          label: "Adresse",                      type: "text" },
    { id: "objekttyp",        label: "Objekttyp",                    type: "select",
      options: ["Etagenwohnung","Wohnung","Einfamilienhaus","Gewerbe","MFH"] },
    { id: "baujahr",          label: "Baujahr",                      type: "text" },
    { id: "wohnflaeche",      label: "Wohnfl√§che",                   type: "text" },
    { id: "grundstueck",      label: "bei Haus Grundst√ºcksfl√§che",   type: "text" },
    { id: "etage",            label: "Etage",                        type: "text" },
    { id: "vollgeschosse",    label: "wieviele Vollgeschosse",       type: "text" },
    { id: "keller",           label: "Keller",                       type: "text" }, // mandatory via list
    { id: "fassade_daemmung", label: "Fassade ‚Äì D√§mmung",            type: "select",
      options: ["unbekannt","D√§mmung","keine D√§mmung"] },
    { id: "dachgeschoss",     label: "Dachgeschoss",                 type: "select",
      options: ["unbekannt","ausgebaut","nicht ausgebaut","Flachdach"] },
    { id: "straenge",         label: "Str√§nge erneuert",             type: "select",
      options: ["unbekannt","Ja","Nein"] },
    { id: "fenster_material", label: "Fenster Material",             type: "select",
      options: ["unbekannt","Holz","Kunststoff","Sonstiges"] },
    { id: "fenster_verglas",  label: "Fenster Verglasung",           type: "select",
      options: ["unbekannt","Einfach verglast","Doppelt verglast","Sonstiges"] },
    { id: "baujahr_fenster",  label: "Baujahr Fenster",              type: "text" },
    { id: "heizung",          label: "Heizung",                      type: "select",
      options: ["unbekannt","Ofenheizung","Gas-Etagenheizung","Gas-Zentralheizung",
                "√ñl-Zentralheizung","Fernw√§rme","Fernw√§rme (Gas)","Sonstiges"] },
    { id: "baujahr_heizung",  label: "Baujahr Heizung",              type: "text" },
    { id: "warmwasser",       label: "Warmwasser",                   type: "select",
      options: ["unbekannt","zentral","zentral (mit Warmwasser)","dezentral"] }
  ];

  const comparisonBody = document.getElementById("comparison-body");

  /* ===== TABLE: FIELD ROW ===== */
  function addFieldRow(field) {
    const tr = document.createElement("tr");
    tr.dataset.rowType = "field";
    tr.dataset.fieldId = field.id;

    const isMandatory = MANDATORY_FIELDS.includes(field.id);
    if (isMandatory) tr.classList.add("mandatory-row");

    const descTd = document.createElement("td");
    descTd.dataset.label = "üßæ Field";
    descTd.textContent = field.label;

    // mandatory rows cannot be deleted
    if (!isMandatory) {
      const trash = document.createElement("button");
      trash.type = "button";
      trash.className = "trash-inline";
      trash.textContent = "üóë";
      trash.addEventListener("click", () => {
        if (confirm("Remove this row?")) tr.remove();
      });
      descTd.appendChild(trash);
    }
    tr.appendChild(descTd);

    const exposeTd = document.createElement("td");
    exposeTd.className = "expose-cell";
    exposeTd.dataset.label = "üè¢ Expos√©";
    const exposeValue = EXPOSE_DATA[field.id] || "";
    exposeTd.textContent = exposeValue;
    tr.appendChild(exposeTd);

    const realityTd = document.createElement("td");
    realityTd.classList.add("editable");
    realityTd.dataset.label = "‚úÖ Reality";

    const copyBtn = document.createElement("button");
    copyBtn.type = "button";
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "Copy from expos√©";

    if (field.type === "text") {
      const span = document.createElement("span");
      span.className = "cell-editable";
      span.contentEditable = "true";
      span.dataset.placeholder = "Write your inspection result‚Ä¶";
      span.innerHTML = '<span style="opacity:0.35;">Write your inspection result‚Ä¶</span>';

      span.addEventListener("focus", () => {
        if (span.querySelector("span")) span.textContent = "";
      });

      copyBtn.addEventListener("click", () => {
        span.textContent = exposeValue || "";
      });

      realityTd.appendChild(copyBtn);
      realityTd.appendChild(span);

    } else if (field.type === "select") {
      const select = document.createElement("select");
      select.style.width = "100%";
      select.style.padding = "3px 6px";
      select.style.borderRadius = "10px";
      select.style.border = "1px solid #dcd3ff";

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "Select‚Ä¶";
      select.appendChild(ph);

      field.options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        select.appendChild(opt);
      });

      copyBtn.addEventListener("click", () => {
        const val = (exposeValue || "").trim();
        if (!val) return;
        const opts = Array.from(select.options);
        let idx = opts.findIndex(o => o.value === val);
        if (idx === -1) {
          idx = opts.findIndex(o => val.toLowerCase().includes(o.value.toLowerCase()));
        }
        if (idx >= 0) select.selectedIndex = idx;
      });

      realityTd.appendChild(copyBtn);
      realityTd.appendChild(select);
    }

    tr.appendChild(realityTd);
    comparisonBody.appendChild(tr);
  }

  /* ===== TABLE: PHOTO ROW ===== */
  let currentPhotoRowForCamera = null;

  function addPhotoRow(label) {
    const tr = document.createElement("tr");
    tr.dataset.rowType = "photo";

    const descTd = document.createElement("td");
    descTd.dataset.label = "üßæ Field";
    descTd.textContent = label || "Photo ‚Äì reality vs expos√©";
    const tag = document.createElement("span");
    tag.className = "row-type-tag";
    tag.textContent = "PHOTO ROW";
    descTd.appendChild(tag);

    const trash = document.createElement("button");
    trash.type = "button";
    trash.className = "trash-inline";
    trash.textContent = "üóë";
    trash.addEventListener("click", () => {
      if (confirm("Remove this row?")) tr.remove();
    });
    descTd.appendChild(trash);

    tr.appendChild(descTd);

    const exposeTd = document.createElement("td");
    exposeTd.className = "expose-cell";
    exposeTd.dataset.label = "üè¢ Expos√©";
    exposeTd.textContent = "";
    tr.appendChild(exposeTd);

    const realityTd = document.createElement("td");
    realityTd.classList.add("editable");
    realityTd.dataset.label = "‚úÖ Reality";

    const copyBtn = document.createElement("button");
    copyBtn.type = "button";
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "Copy from expos√©";

    const camBtn = document.createElement("button");
    camBtn.type = "button";
    camBtn.className = "photo-upload-btn";
    camBtn.textContent = "üì∑ Camera";

    const uploadBtn = document.createElement("button");
    uploadBtn.type = "button";
    uploadBtn.className = "photo-upload-btn";
    uploadBtn.textContent = "üóÇ Upload";

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.setAttribute("capture", "environment");
    input.style.display = "none";

    const editor = document.createElement("div");
    editor.className = "photo-editor";

    const helper = document.createElement("div");
    helper.className = "photo-helper";
    helper.textContent = "Take a photo or upload, then draw rectangles to mark issues.";

    const canvas = document.createElement("canvas");
    canvas.width = 320;
    canvas.height = 200;

    const commentsList = document.createElement("ul");
    commentsList.className = "photo-comments";

    const note = document.createElement("textarea");
    note.className = "photo-note";
    note.rows = 2;
    note.placeholder = "Optional reality note for this photo‚Ä¶";

    editor.appendChild(helper);
    editor.appendChild(canvas);
    editor.appendChild(commentsList);
    editor.appendChild(note);

    realityTd.appendChild(copyBtn);
    realityTd.appendChild(camBtn);
    realityTd.appendChild(uploadBtn);
    realityTd.appendChild(input);
    realityTd.appendChild(editor);

    tr.appendChild(realityTd);
    comparisonBody.appendChild(tr);

    // rectangle drawing
    let img = new Image();
    let rects = [];
    let markerCount = 0;
    let isDrawing = false;
    let startX = 0, startY = 0;

    function redraw() {
      if (!img.src) return;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const scale = Math.min(canvas.width/img.width, canvas.height/img.height);
      const w = img.width*scale, h = img.height*scale;
      const dx = (canvas.width - w)/2;
      const dy = (canvas.height - h)/2;
      ctx.drawImage(img, dx, dy, w, h);
      ctx.lineWidth = 2;
      ctx.font = "11px system-ui";
      rects.forEach(r => {
        ctx.strokeStyle = "#d62839";
        ctx.fillStyle = "rgba(214,40,57,0.18)";
        ctx.fillRect(r.x,r.y,r.w,r.h);
        ctx.strokeRect(r.x,r.y,r.w,r.h);
        ctx.fillStyle = "#d62839";
        ctx.fillRect(r.x, r.y-14, 18, 14);
        ctx.fillStyle = "#fff";
        ctx.fillText(String(r.id), r.x+5, r.y-3);
      });
    }

    function loadImageFromDataUrl(dataUrl) {
      img = new Image();
      img.onload = () => {
        canvas.style.display = "block";
        rects = [];
        markerCount = 0;
        commentsList.innerHTML = "";
        redraw();
      };
      img.src = dataUrl;
    }

    uploadBtn.addEventListener("click", () => input.click());
    input.addEventListener("change", () => {
      if (!input.files || !input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => loadImageFromDataUrl(e.target.result);
      reader.readAsDataURL(input.files[0]);
    });

    camBtn.addEventListener("click", () => {
      currentPhotoRowForCamera = tr;
      openCamera();
    });

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener("pointerdown", e => {
      if (!img.src) return;
      isDrawing = true;
      const p = getPos(e);
      startX = p.x; startY = p.y;
    });
    canvas.addEventListener("pointerup", e => {
      if (!img.src || !isDrawing) return;
      isDrawing = false;
      const p = getPos(e);
      const endX = p.x, endY = p.y;
      const w = Math.abs(endX - startX), h = Math.abs(endY - startY);
      if (w < 4 || h < 4) return;
      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const comment = prompt("Comment for this rectangle?");
      if (!comment) return;
      markerCount++;
      rects.push({ id: markerCount, x, y, w, h, comment });
      const li = document.createElement("li");
      li.textContent = markerCount + ". " + comment;
      commentsList.appendChild(li);
      redraw();
    });

    copyBtn.addEventListener("click", () => {
      note.value = exposeTd.textContent.trim();
    });

    tr.getPhotoData = function() {
      const comments = [];
      commentsList.querySelectorAll("li").forEach(li => comments.push(li.textContent));
      let imageData = null;
      if (canvas.style.display !== "none") {
        imageData = canvas.toDataURL("image/jpeg", 0.85);
      }
      return { note: note.value.trim(), comments, imageData };
    };

    tr.loadCameraImage = function(dataUrl) {
      loadImageFromDataUrl(dataUrl);
    };
  }

  function loadTemplate() {
    comparisonBody.innerHTML = "";
    inspectionFields.forEach(addFieldRow);
  }
  loadTemplate();

  /* ===== TABLE CONTROLS ===== */
  document.getElementById("add-text-row-btn").addEventListener("click", () => {
    const label = prompt("New row title:", "Extra note");
    if (!label) return;
    const field = { id: "custom_" + Date.now(), label, type: "text" };
    addFieldRow(field);
  });

  document.getElementById("add-photo-row-btn").addEventListener("click", () => {
    const label = prompt("Photo row description:", "Additional photo");
    addPhotoRow(label || "Additional photo");
  });

  document.getElementById("reset-example-btn").addEventListener("click", () => {
    if (confirm("Reset table to default Maske Inspektion?")) loadTemplate();
  });

  function sampleTexts() {
    return [
      "Matches expos√©. Staircase worn but OK.",
      "Ceiling lower than expected; slight smoke smell.",
      "Feels smaller than advertised.",
      "Walls need plaster & new paint.",
      "Small backyard, needs gardening.",
      "3rd floor, no lift.",
      "4 full floors + attic.",
      "Keller slightly damp but usable.",
      "Facade OK, some cracks.",
      "Attic partly converted.",
      "Old pipes in places.",
      "Mixed wooden / plastic windows.",
      "Double glazing only in living room.",
      "Windows early 2000s.",
      "Gas central heating, boiler in basement.",
      "Boiler from ~1998.",
      "Hot water central for all flats."
    ];
  }

  document.getElementById("mock-autofill-btn").addEventListener("click", () => {
    const texts = sampleTexts();
    let i = 0;
    comparisonBody.querySelectorAll("tr").forEach(tr => {
      if (tr.dataset.rowType !== "field") return;
      const cell = tr.querySelector("td.editable");
      if (!cell) return;
      const sel = cell.querySelector("select");
      const span = cell.querySelector(".cell-editable");
      if (sel) {
        if (i < texts.length) {
          sel.selectedIndex = 1;
          i++;
        }
      } else if (span && i < texts.length) {
        span.textContent = texts[i++];
      }
    });
  });

  /* ===== STEP 1 UPLOAD / EXAMPLE ===== */
  const dropArea = document.getElementById("drop-area");
  const fileInput = document.getElementById("file-input");
  const selectFileBtn = document.getElementById("select-file-btn");
  const fileInfo = document.getElementById("file-info");
  const loadExampleBtn = document.getElementById("load-example-btn");
  let currentFileName = null;

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  ["dragenter","dragover","dragleave","drop"].forEach(ev => {
    dropArea.addEventListener(ev, preventDefaults, false);
  });
  ["dragenter","dragover"].forEach(ev => {
    dropArea.addEventListener(ev, () => dropArea.classList.add("dragover"), false);
  });
  ["dragleave","drop"].forEach(ev => {
    dropArea.addEventListener(ev, () => dropArea.classList.remove("dragover"), false);
  });

  dropArea.addEventListener("drop", e => {
    const file = e.dataTransfer.files[0];
    handleFile(file);
  });

  selectFileBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    handleFile(file);
  });

  function handleFile(file) {
    if (!file) return;
    if (file.type !== "application/pdf") {
      alert("Please upload a PDF file.");
      return;
    }
    currentFileName = file.name;
    fileInfo.textContent = "Loaded: " + file.name + " (values from sample expos√© for now)";
    selectFileBtn.textContent = "‚ú® Make the magic";
    loadTemplate();
    if (currentMaxStep < 2) {
      currentMaxStep = 2;
      updateStepAccess();
    }
  }

  loadExampleBtn.addEventListener("click", () => {
    currentFileName = "Berlin_Expose_Kantstr_123.pdf";
    fileInfo.textContent = "Using built-in fake Berlin expos√©.";
    selectFileBtn.textContent = "‚ú® Make the magic";
    loadTemplate();
    if (currentMaxStep < 2) {
      currentMaxStep = 2;
      updateStepAccess();
    }
  });

  /* ===== LOGO PNG PRELOAD ===== */
  let logoImageData = null;
  (function preloadLogo() {
    const img = new Image();
    img.onload = () => {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        logoImageData = canvas.toDataURL("image/png");
      } catch(e) {
        logoImageData = null;
      }
    };
    img.onerror = () => { logoImageData = null; };
    img.src = "Logo.png";
  })();

  /* ===== SIGNATURE PAD ===== */
  const sigCanvas = document.getElementById("signature-pad");
  const sigCtx = sigCanvas.getContext("2d");
  let isSigning = false;
  let sigDirty = false;

  function resizeSigCanvas() {
    const rect = sigCanvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;
    sigCanvas.width = rect.width * ratio;
    sigCanvas.height = rect.height * ratio;
    sigCtx.setTransform(ratio,0,0,ratio,0,0);
    sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    sigDirty = false;
  }
  window.addEventListener("resize", resizeSigCanvas);
  resizeSigCanvas();

  function sigPos(e) {
    const rect = sigCanvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  sigCanvas.addEventListener("pointerdown", e => {
    isSigning = true;
    const p = sigPos(e);
    sigCtx.beginPath();
    sigCtx.moveTo(p.x, p.y);
    sigDirty = true;
  });
  sigCanvas.addEventListener("pointermove", e => {
    if (!isSigning) return;
    const p = sigPos(e);
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = "round";
    sigCtx.strokeStyle = "#111";
    sigCtx.lineTo(p.x, p.y);
    sigCtx.stroke();
  });
  window.addEventListener("pointerup", () => {
    isSigning = false;
  });

  document.getElementById("clear-signature-btn").addEventListener("click", () => {
    resizeSigCanvas();
  });

  /* ===== CAMERA MODAL ===== */
  const cameraModal = document.getElementById("camera-modal");
  const cameraView  = document.getElementById("camera--view");
  const cameraTrigger = document.getElementById("camera--trigger");
  const cameraSensor  = document.getElementById("camera--sensor");
  const cameraOutput  = document.getElementById("camera--output");
  const cameraClose   = document.getElementById("camera-close");
  let cameraStream = null;

  async function openCamera() {
    cameraModal.classList.add("visible");
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      cameraView.srcObject = cameraStream;
    } catch(e) {
      alert("Camera not available. You can still use Upload on the photo row.");
      closeCamera();
    }
  }

  function closeCamera() {
    cameraModal.classList.remove("visible");
    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
  }

  cameraClose.addEventListener("click", () => {
    closeCamera();
    currentPhotoRowForCamera = null;
  });

  cameraTrigger.addEventListener("click", () => {
    if (!cameraStream || !currentPhotoRowForCamera) return;
    const width  = cameraView.videoWidth;
    const height = cameraView.videoHeight;
    cameraSensor.width = width;
    cameraSensor.height = height;
    const ctx = cameraSensor.getContext("2d");
    ctx.drawImage(cameraView, 0, 0);
    const dataUrl = cameraSensor.toDataURL("image/jpeg", 0.9);
    cameraOutput.src = dataUrl;
    const fn = currentPhotoRowForCamera.loadCameraImage;
    if (typeof fn === "function") fn(dataUrl);
    closeCamera();
    currentPhotoRowForCamera = null;
  });

  /* ===== GENERIC MANDATORY VALIDATION ===== */
  function validateMandatoryFields() {
    let firstErrorCell = null;

    // clear old errors
    comparisonBody.querySelectorAll("tr.mandatory-row").forEach(tr => {
      tr.classList.remove("row-error");
      const cell = tr.querySelector("td.editable");
      if (cell) cell.classList.remove("field-error");
    });

    let allGood = true;

    comparisonBody.querySelectorAll("tr.mandatory-row").forEach(tr => {
      const cell = tr.querySelector("td.editable");
      let val = "";

      if (cell) {
        const sel = cell.querySelector("select");
        const span = cell.querySelector(".cell-editable");
        if (sel) {
          val = (sel.value || "").trim();
        } else if (span) {
          let t = span.innerText.replace(/\s+/g, " ").trim();
          if (/write your inspection result/i.test(t)) t = "";
          val = t;
        }
      }

      if (!val) {
        allGood = false;
        tr.classList.add("row-error");
        if (cell) {
          cell.classList.add("field-error");
          if (!firstErrorCell) firstErrorCell = cell;
        }
      }
    });

    if (!allGood && firstErrorCell) {
      firstErrorCell.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    return allGood;
  }

  /* ===== STEP 2 ‚Üí STEP 3 BUTTON (MANDATORY CHECK) ===== */
  const goStep3Btn = document.getElementById("go-step3-btn");

  goStep3Btn.addEventListener("click", () => {
    if (!validateMandatoryFields()) return;
    if (currentMaxStep < 3) {
      currentMaxStep = 3;
      updateStepAccess();
    }
    const step3 = document.getElementById("step3-card");
    step3.scrollIntoView({ behavior: "smooth", block: "start" });
    stepButtons.forEach(b => b.classList.remove("active"));
    stepsFloating.querySelector('button[data-step="3"]').classList.add("active");
  });

  /* ===== PDF GENERATION & PREVIEW ===== */
  const generateBtn = document.getElementById("generate-pdf-btn");
  const validatorInput = document.getElementById("validator");
  const modalBackdrop = document.getElementById("pdf-modal-backdrop");
  const pdfFrame = document.getElementById("pdf-preview-frame");
  const closeModalBtn = document.getElementById("close-modal-btn");
  const cancelDownloadBtn = document.getElementById("cancel-download-btn");
  const approveDownloadBtn = document.getElementById("approve-download-btn");
  const modalValidatorLabel = document.getElementById("modal-validator-label");
  const modalValidatorFooter = document.getElementById("modal-validator-footer");

  let lastPdfBlob = null;
  let lastPdfFilename = null;
  let lastValidatorName = "";

  function clearValidationErrors() {
    validatorInput.classList.remove("field-error");

    comparisonBody.querySelectorAll("tr.mandatory-row").forEach(tr => {
      tr.classList.remove("row-error");
      const cell = tr.querySelector("td.editable");
      if (cell) cell.classList.remove("field-error");
    });
  }

  generateBtn.addEventListener("click", () => {
    clearValidationErrors();
    const validator = validatorInput.value.trim();
    let hasError = false;

    if (!validator) {
      validatorInput.classList.add("field-error");
      validatorInput.scrollIntoView({ behavior: "smooth", block: "center" });
      hasError = true;
    }

    if (!validateMandatoryFields()) {
      hasError = true;
    }

    if (hasError) return;

    const now = new Date();
    const timeStr = String(now.getHours()).padStart(2,"0") + String(now.getMinutes()).padStart(2,"0");
    const baseName = (EXPOSE_DATA.adresse || "Flat").replace(/[^\w]+/g,"_");
    lastPdfFilename = baseName + "_" + timeStr + ".pdf";
    lastValidatorName = validator;

    const doc = new jsPDF({ unit: "mm", format: "a4" });

    // HEADER
    doc.setFillColor(30, 12, 60);
    doc.rect(0,0,210,25,"F");
    doc.setTextColor(255,255,255);
    doc.setFontSize(12);
    doc.setFont("helvetica","bold");
    doc.text("Check Your Flat", 12, 12);
    doc.setFontSize(15);
    doc.text("Inspection report", 12, 20);

    if (logoImageData) {
      doc.addImage(logoImageData, "PNG", 178, 4, 24, 17);
    } else {
      doc.setDrawColor(255,184,92);
      doc.circle(188, 12, 8);
      doc.setFontSize(9);
      doc.text("CYF", 184.5, 14);
    }

    // META INFO
    doc.setTextColor(20, 12, 40);
    doc.setFontSize(11);

    let metaY = 38;

    function addMeta(label, value) {
      if (!value) return;
      doc.setFont("helvetica", "bold");
      doc.text(label, 12, metaY);
      doc.setFont("helvetica", "normal");
      doc.text(value, 20, metaY + 5);
      metaY += 11;
    }

    const dateStr = now.toLocaleString();
    const addressLine = EXPOSE_DATA.adresse || "";

    addMeta("Address:", addressLine);
    addMeta("Generated:", dateStr);
    if (currentFileName) addMeta("Source expos√©:", currentFileName);
    addMeta("Validator (inspector):", validator);

    metaY += 4;

    // TABLE HEADING
    doc.setFontSize(12);
    doc.setTextColor(30, 12, 60);
    doc.setFont("helvetica", "bold");
    doc.text("Maske Inspektion ‚Äì inspector notes", 12, metaY);
    doc.setLineWidth(0.3);
    doc.setDrawColor(180, 170, 230);
    doc.line(12, metaY + 2, 198, metaY + 2);

    doc.setFontSize(9);
    doc.setFont("helvetica","normal");
    doc.setTextColor(30,20,60);
    let y = metaY + 9;
    const lineHeight = 5;

    // COLLECT ROWS
    const rows = [];
    comparisonBody.querySelectorAll("tr").forEach(tr => {
      const type  = tr.dataset.rowType || "field";
      const cells = tr.querySelectorAll("td");

      let desc = "";
      if (cells[0]) {
        const firstNode = cells[0].childNodes[0];
        desc = (firstNode && firstNode.textContent ? firstNode.textContent : "")
          .replace(/\s+/g, " ")
          .trim();
      }

      let reality = "";
      let photoData = null;

      if (type === "field") {
        const cell = cells[2];
        if (cell) {
          const sel = cell.querySelector("select");
          const span = cell.querySelector(".cell-editable");
          if (sel) {
            reality = (sel.value || "").trim();
          } else if (span) {
            let txt = span.innerText.replace(/\s+/g," ").trim();
            if (/write your inspection result/i.test(txt)) txt = "";
            reality = txt;
          }
        }
      } else if (type === "photo") {
        const fn = tr.getPhotoData;
        if (typeof fn === "function") photoData = fn();
        const note = photoData && photoData.note ? photoData.note : "";
        reality = note;
      }

      rows.push({ type, desc, reality, photoData });
    });

    // WRITE ROWS (skip empty, continuous numbering)
    let displayIndex = 0;
    rows.forEach(row => {
      const hasPhotoContent =
        row.type === "photo" &&
        row.photoData &&
        (row.photoData.note ||
         (row.photoData.comments && row.photoData.comments.length) ||
         row.photoData.imageData);

      if (row.type === "field" && !row.reality) return;
      if (row.type === "photo" && !hasPhotoContent) return;

      displayIndex += 1;

      if (y > 280) {
        doc.addPage();
        y = 20;
      }

      const linePrefix = displayIndex + ". ";

      doc.setTextColor(30, 20, 60);
      doc.setFont("helvetica", "bold");
      doc.text(linePrefix + row.desc, 12, y);
      y += lineHeight;

      if (row.reality) {
        doc.setTextColor(18, 90, 70);
        doc.setFont("helvetica", "normal");
        doc.text("Inspector reality: " + row.reality, 16, y);
        y += lineHeight;
      }

      if (row.type === "photo" && row.photoData && row.photoData.comments.length) {
        doc.setTextColor(80, 60, 120);
        doc.text("Photo markers:", 16, y);
        y += lineHeight;
        row.photoData.comments.forEach(c => {
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text("- " + c, 18, y);
          y += lineHeight;
        });
      }

      if (row.type === "photo" && row.photoData && row.photoData.imageData) {
        const imgProps = doc.getImageProperties(row.photoData.imageData);
        const imgWidth = 70;
        const imgHeight = imgWidth * (imgProps.height / imgProps.width);

        if (y + imgHeight > 280) {
          doc.addPage();
          y = 20;
        }

        doc.addImage(
          row.photoData.imageData,
          "JPEG",
          16,
          y,
          imgWidth,
          imgHeight
        );
        y += imgHeight + lineHeight;
      }

      y += 1;
      doc.setTextColor(30, 20, 60);
    });

    // SIGNATURE AT BOTTOM OF LAST PAGE (centered layout)
    let sigY = y + 15;
    if (sigY < 230) sigY = 230;
    if (sigY > 260) {
      doc.addPage();
      sigY = 230;
    }

    // line coordinates
    const lineStartX = 75;
    const lineEndX   = 125;

    // signature image size
    const sigWidth  = 60;
    const sigHeight = 20;

    // center signature above the line
    const sigX = (lineStartX + lineEndX - sigWidth) / 2;
    const sigYTop = sigY - 10; // above the line

    // draw signature image
    if (sigDirty) {
      const sigDataUrl = sigCanvas.toDataURL("image/png");
      doc.addImage(sigDataUrl, "PNG", sigX, sigYTop, sigWidth, sigHeight);
    }

    // draw line
    doc.setDrawColor(150, 140, 190);
    doc.line(lineStartX, sigY + 10, lineEndX, sigY + 10);

    // centered validator label under the line
    doc.setFontSize(9);
    doc.setTextColor(60, 50, 90);

    if (validator) {
      const textWidth = doc.getTextWidth(validator);
      const textX = (lineStartX + lineEndX - textWidth) / 2;
      doc.text(validator, textX, sigY + 20);
    }

    const blob = doc.output("blob");
    lastPdfBlob = blob;

    const url = URL.createObjectURL(blob);
    pdfFrame.src = url;
    modalValidatorLabel.textContent = "Validator: " + validator;
    modalValidatorFooter.textContent = "Check the PDF. If OK, approve & download.";
    modalBackdrop.classList.add("visible");
  });

  function closeModal() {
    modalBackdrop.classList.remove("visible");
    pdfFrame.src = "";
    if (lastPdfBlob) {
      URL.revokeObjectURL(lastPdfBlob);
      lastPdfBlob = null;
    }
  }

  document.getElementById("close-modal-btn").addEventListener("click", closeModal);
  document.getElementById("cancel-download-btn").addEventListener("click", closeModal);

  approveDownloadBtn.addEventListener("click", () => {
    if (!lastPdfBlob || !lastPdfFilename) return;
    const url = URL.createObjectURL(lastPdfBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = lastPdfFilename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    saveHistoryEntry({
      filename: lastPdfFilename,
      when: new Date().toLocaleString(),
      address: EXPOSE_DATA.adresse || "",
      validator: lastValidatorName || ""
    });

    closeModal();
  });

  /* ===== HISTORY ===== */
  const HISTORY_KEY = "cyf-history-v3";
  const historyListEl = document.getElementById("history-list");

  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch { return []; }
  }

  function saveHistoryEntry(entry) {
    const list = loadHistory();
    list.unshift(entry);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0, 40)));
  }

  function renderHistory() {
    const list = loadHistory();
    historyListEl.innerHTML = "";
    if (!list.length) {
      const p = document.createElement("p");
      p.style.fontSize = "11px";
      p.style.color = "#7a719d";
      p.textContent = "No reports exported yet.";
      historyListEl.appendChild(p);
      return;
    }
    list.forEach(item => {
      const div = document.createElement("div");
      div.className = "history-item";

      const main = document.createElement("div");
      main.className = "history-main";

      const title = document.createElement("div");
      title.textContent = item.filename;

      const meta = document.createElement("div");
      meta.className = "history-meta";
      meta.textContent = item.address + " ‚Ä¢ " + item.when +
        (item.validator ? " ‚Ä¢ " + item.validator : "");

      main.appendChild(title);
      main.appendChild(meta);

      const tag = document.createElement("span");
      tag.className = "history-tag";
      tag.textContent = "PDF";

      div.appendChild(main);
      div.appendChild(tag);

      historyListEl.appendChild(div);
    });
  }

  renderHistory();
})();
</script>
</body>
</html>
